[ODS]
filename : fact_energy_service_activity_warp
srcconnectionstring :  Warp
tgtconnectionstring :  Utopia
srctablename : Warpoem.dbo.Inquiry
trgtablename : ODS.EN_WarpOEM_Activity
incrementallabel: select ifnull(LastEtlRunDate,'1970-01-01')  as LastEtlRunDate from audit.ETL_Incremental where TableName = 'EN_WarpOEM_Activity'
eventfile :
taskid : ODS.EN_WarpOEM_Activity
truncatetgtquery : truncate table ODS.EN_WarpOEM_Activity;
dependencyflag : false
selectquery : Select
                I.InquiryID as ServiceActivityID
                ,ISS.InquiryStatusName as ActivityStatus
                ,I.CreateByUSerID as CreatedByUSerID
                ,I.CreateDate
                ,I.ModifyByUserID
                ,I.ModifyDate
                ,I.Enabled
                ,I.ModifyDate as LastUpdateDate
                ,LEFT(I.InquiryNarrative , 8000 ) as CustomerNarrative
                ,I.DueDate
                ,IST.InquirySourceName as ActivitySource
                ,IT.InquiryTypeName as ActivityCategory
                ,ISR.Severity
                ,IW.Workflow as Workflow
                ,oem.OemProgramName as OemProgramName
                ,getdate() as ETLCreatedDate
                ,'Fact_EnergyServiceActivity/ODS.EN_WarpOEM_Activity' as ETLCreatedBy
                ,coalesce(I.ModifyDate,I.CreateDate) as tsdate
                ,51 as SourceSystemKey
                ,'SJC' as DataCenterCode
                ,'Warp' as SourceType
                ,I.SerialNumber
                ,I.VIN
                ,concat(I.CustomerFirstName,' ',I.CustomerLastName) as CustomerName
                ,I.CustomerEmail
                ,i.ClosedDate
                ,cast(pim.ProjectID as int) as ProjectID
				 ,I.FirmwareVersion
				 ,I.CustomerCaseNumber
				 ,I.CustomerNotes
				 ,I.CustomerPhone
				 ,I.AssignedTo
				 ,I.PartNumber
				 ,I.WorkflowID
                 ,I.PriorityRequest
				 ,I.SiteLabel
                 ,I.ClosedByUserId
				 ,INS.InstallerName
				 ,INS.companyname
				 ,INS.EmailAddress as InstallerEmail
				 ,INS.PhoneNumber as InstallerPhone
				 ,oep.OemPartnerName
				 ,Reg.ServiceRORegionId
                 ,Reg.ServiceRORegion
                 ,RS.RepairStatusName
                 ,IC.Country
                 ,CASE
               WHEN I.CreateByUserID = 0
                       THEN 'System'
               ELSE ISNULL(concat(I.CustomerFirstName,I.CustomerLastName), '')
               END AS UserName
               ,CASE
                 WHEN I.AssignedTo = 0
                   THEN 'System'
                   WHEN I.AssignedToType = 'DistributionList'
                   THEN d.DistributionListName
                   ELSE ISNULL(CONCAT (
                    I.CustomerFirstName,' '
                        ,I.CustomerLastName
                        ) , '')
                   END AS AssignedToName
               ,CASE
                 WHEN I.CreateByUserID = 0
                    THEN 'System'
                    ELSE ISNULL(CONCAT (
                   I.CustomerFirstName
                    ,I.CustomerLastName
                   ), '')
                END as CreatedByName
                ,Inq2.InquiryNumber as ParentInquiryNumber
                ,I.InquiryNumber

            from Warpoem.dbo.Inquiry I
            left join Warpoem.dbo.InquiryStatus(nolock) ISS on I.InquiryStatusID = ISS.InquiryStatusID
            left join Warpoem.dbo.InquirySource (nolock)IST on I.InquirySourceID = IST.InquirySourceID
            LEFT JOIN  WarpOEM.dbo.Inquiry (Nolock) Inq2 ON I.ParentInquiryID=Inq2.InquiryID
            left join Warpoem.dbo.inquirytype IT (nolock)on  I.inquiryTypeID = IT.inquiryTypeID
            left join Warpoem.dbo.InquirySeverity(nolock) ISR on  I.inquiryTypeID = ISR.InquirySeverityID
            Left Join warpoem.dbo.Inquiryworkflow (nolock) IW ON (I.workflowID = IW.InquiryWorkflowID)
            Left Join warpoem.dbo.oemProgram (nolock) oem ON (I.oemid = oem.oemid and i.oemprogramid=oem.oemprogramid)
			Left Join WarpSC.dbo.Installer (nolock) INS on I.InstallerId = INS.InstallerId
			Left Join warpoem.dbo.OemPartner (nolock) oep on I.oemid = oep.oemid
			Left Join warpoem.dbo.ServiceRORegion (nolock) Reg ON (I.RegionId = Reg.ServiceRORegionId)
            LEFT JOIN (Select   ProjectId,InquiryNumber,cast(createdate as Datetime) createdate,cast(modifydate as Datetime) modifydate,ROW_NUMBER() OVER(PARTITION BY   ProjectId,InquiryNumber ORDER BY createdate desc) Rn from WarpSC.dbo.ProjectInquiryMapping Where Enabled = 1) PIM ON (PIM.InquiryNumber = I.InquiryNumber and I.Enabled = 1 and PIM.RN = 1)
            LEFT JOIN Warpoem.dbo.RepairStatus RS ON I.RepairStatusID = RS.RepairStatusID
            left join Warpoem.dbo.InquiryCountry IC on I.InquiryCountryId = IC.InquiryCountryId
            left join warpoem.dbo.DistributionList d on I.AssignedTo = d.DistributionListId
            where coalesce(I.ModifyDate,I.CreateDate) >= cast('{0}' as datetime);
updatequery :
softdeletequery :
truncaterefequery :
refrtableinsertquery :
refrtableupdatequery :
refrtabledeletequery:
updateincrquery :
executionsequence: truncatetgtquery,selectquery
batchflag: false
incrementbatch :

[STG]
filename : fact_energy_service_activity_warp
srcconnectionstring : Utopia
tgtconnectionstring : Utopia
srctablename : ODS.EN_WarpOEM_Activity
trgtablename : STAGE.EN_WarpOEM_Activity
eventfile :
taskid : STAGE.EN_WarpOEM_Activity
truncatetgtquery : Truncate table STAGE.EN_WarpOEM_Activity ;
dependencyflag :
insertquery :  INSERT INTO STAGE.EN_WarpOEM_Activity
            (
			    ServiceActivityID
                ,ActivityStatus
                ,CreatedByUserID
                ,CreateDate
                ,ModifyByUserID
                ,ModifyDate
                ,Enabled
                ,LastUpdateDate
                ,CustomerNarrative
                ,ActivitySource
                ,ActivityCategory
                ,Severity
                ,OemProgramName
                ,ETLCreatedDate
                ,ETLCreatedBy
                ,SourceSystemKey
                ,DataCenterCode
                ,SourceType
	            ,SerialNumber
                ,VIN
                ,CustomerName
                ,CustomerEmail
               ,ClosedDate
               ,ProjectID
			     ,FirmwareVersion
				 ,CustomerCaseNumber
				 ,CustomerNotes
				 ,CustomerPhone
				 ,AssignedTo
				 ,PartNumber
				 ,WorkflowID
				 ,PriorityRequest
				 ,SiteLabel
				 ,ClosedByUserId
				 ,InstallerName
				,companyname
				,InstallerEmail
				,InstallerPhone
				,OemPartnerName
				,ServiceRORegionId
                ,ServiceRORegion
                ,RepairStatusName
                ,ServiceSubRegion
                ,Country
                ,UserName
                ,AssignedToName
                ,CreatedByName
               ,SiteKey
               ,ParentInquiryNumber
               ,InquiryNumber

            )
            select
                 a.ServiceActivityID
                ,a.ActivityStatus
                ,a.CreatedByUserID
                ,a.CreateDate
                ,a.ModifyByUserID
                ,a.ModifyDate
                ,a.Enabled
                ,a.LastUpdateDate
                ,a.CustomerNarrative
                ,a.ActivitySource
                ,a.ActivityCategory
                ,a.Severity
                ,a.OemProgramName
                ,CURRENT_TIMESTAMP(0) AT TIME ZONE 'America/Los_Angeles' as ETLCreatedDate
                ,'Fact_EnergyServiceActivity/STAGE.EN_WarpOEM_Activity' as ETLCreatedBy
                ,a.SourceSystemKey
                ,a.DataCenterCode
                ,a.SourceType
                ,a.SerialNumber
                ,a.VIN
                ,a.CustomerName
                ,a.CustomerEmail
                ,a.ClosedDate
                ,a.ProjectID::decimal::int
				 ,a.FirmwareVersion
				 ,a.CustomerCaseNumber
				 ,a.CustomerNotes
				 ,a.CustomerPhone
				 ,a.AssignedTo
				 ,a.PartNumber
				 ,a.WorkflowID
				 ,a.PriorityRequest
				 ,a.SiteLabel
				  ,a.ClosedByUserId::decimal::int
				  ,a.InstallerName
				,a.companyname
				,a.InstallerEmail
				,a.InstallerPhone
				,a.OemPartnerName
				,a.ServiceRORegionId
                ,a.ServiceRORegion
                ,a.RepairStatusName
                ,dsa.SiteAttributeDescription as ServiceSubRegion
                ,a.Country
                ,a.UserName
                ,a.AssignedToName
                ,a.CreatedByName
                ,Coalesce(ds.SiteKey , -1) as SiteKey
                ,a.ParentInquiryNumber
                ,a.InquiryNumber
            from  ODS.EN_WarpOEM_Activity a
            left join InstallbaseDM.Dim_Site ds on ds.projectid = a.projectid::decimal::int and ds.DataCenterCode = a.DataCenterCode
            left join InstallbaseDM.Dim_SiteAttribute dsa on dsa.projectid = a.projectid::decimal::int and dsa.DataCenterCode = a.DataCenterCode ;
updatequery :
softdeletequery :
truncaterefequery :
refrtableinsertquery :
refrtableupdatequery :
refrtabledeletequery:
updateincrquery:
executionsequence: truncatetgtquery,insertquery
batchflag:
incrementbatch :

[EDW]
filename : fact_energy_service_activity_warp
srcconnectionstring :  Utopia
tgtconnectionstring :  Utopia
srctablename : STAGE.EN_WarpOEM_Activity
trgtablename : EnergyDM.Fact_EnergyServiceActivity
eventfile : fact_energy_service_activity.txt
taskid : EnergyDM.Fact_EnergyServiceActivity_Warp
truncatetgtquery :
dependencyflag : false
insertquery : INSERT INTO EnergyDM.Fact_EnergyServiceActivity
            (
                ServiceActivityID
                ,ActivityStatus
                ,CreatedByUserID
                ,CreateDate
                ,ModifyByUserID
                ,ModifyDate
                ,Enabled
                ,LastUpdateDate
                ,CustomerNarrative
                ,ActivitySource
                ,ActivityCategory
                ,Severity
                ,ProductCode
                ,ETLCreatedDate
                ,ETLCreatedBy
                ,SourceSystemKey
                ,DataCenterCode
                ,SourceType
                ,ClosedDate
                ,ProjectID
				,PriorityRequest
				,SiteLabel
				,ClosedByUserId
				,OemPartnerName
                ,PrediagnoseType
                ,ServiceSubRegion
                ,Country
                ,UserName
                ,AssignedToName
                ,CreatedByName
                ,SiteKey

                ,ParentInquiryNumber

                ,vin
            )
            select
                 a.ServiceActivityID
                ,a.ActivityStatus
                ,a.CreatedByUserID
                ,a.CreateDate
                ,a.ModifyByUserID
                ,a.ModifyDate
                ,a.Enabled
                ,a.LastUpdateDate
                ,a.CustomerNarrative
                ,a.ActivitySource
                ,a.ActivityCategory
                ,a.Severity
                ,a.OemProgramName
                ,CURRENT_TIMESTAMP(0) AT TIME ZONE 'America/Los_Angeles' as ETLCreatedDate
                ,'EnergyDM.Fact_EnergyServiceActivity' as ETLCreatedBy
                ,a.SourceSystemKey
                ,a.DataCenterCode
                ,a.SourceType
                ,a.ClosedDate
                ,a.ProjectID
				,a.PriorityRequest
				,a.SiteLabel
				,a.ClosedByUserId
				,a.OemPartnerName
                ,a.RepairStatusName
                ,a.ServiceSubRegion
                ,a.Country
                ,a.UserName
                ,a.AssignedToName
                ,a.CreatedByName
                ,a.SiteKey
                ,a.ParentInquiryNumber
                ,a.vin
            from  STAGE.EN_WarpOEM_Activity a
            Where NOT EXISTS (SELECT 1 FROM EnergyDM.Fact_EnergyServiceActivity lkp
              WHERE a.ServiceActivityID = lkp.ServiceActivityID and a.SourceSystemKey = lkp.SourceSystemKey
              and  a.SourceType = lkp.SourceType) ;
updatequery : update EnergyDM.Fact_EnergyServiceActivity t
                set
                    ActivityStatus = a.ActivityStatus
                    ,CreatedByUserID = a.CreatedByUserID
                    ,CreateDate = a.CreateDate
                    ,ModifyByUserID = a.ModifyByUserID
                    ,ModifyDate = a.ModifyDate
                    ,Enabled = a.Enabled
                    ,LastUpdateDate = a.LastUpdateDate
                    ,CustomerNarrative = a.CustomerNarrative
                    ,ActivitySource = a.ActivitySource
                    ,ActivityCategory = a.ActivityCategory
                    ,Severity = a.Severity
                    ,ProductCode = a.OemProgramName
                    ,DataCenterCode = a.DataCenterCode
                    ,ETLModifiedDate = CURRENT_TIMESTAMP(0) AT TIME ZONE 'America/Los_Angeles'
                    ,ETLModifiedBy = 'EnergyDM.Fact_EnergyServiceActivity'
                    ,ClosedDate = a.ClosedDate
                    ,ProjectID = a.ProjectID
					,PriorityRequest = a.PriorityRequest
					,SiteLabel	     = a.SiteLabel
					,ClosedByUserId = a.ClosedByUserId
					,OemPartnerName = a.OemPartnerName
                    ,PrediagnoseType = a.RepairStatusName
                    ,ServiceSubRegion = a.ServiceSubRegion
                    ,Country = a.Country
                    ,UserName=a.UserName
                    ,AssignedToName = a.AssignedToName
                     ,CreatedByName = a.CreatedByName
                    ,SiteKey  = a.SiteKey
                    ,ParentInquiryNumber = a.ParentInquiryNumber
                    ,vin = a.vin
            from STAGE.EN_WarpOEM_Activity a
            where a.ServiceActivityID = t.ServiceActivityID and a.SourceSystemKey = t.SourceSystemKey
              and  a.SourceType = t.SourceType;
softdeletequery :
truncaterefequery :
refrtableinsertquery : update EnergyDM.Fact_EnergyServiceActivity t
                        Set ServiceVisitID = SV.ServiceVisitID
                        ,SiteVisitKey = SV.SiteVisitKey
                        FROM
                        (Select ods.ServiceVisitID , trim(ods.LinkedInquiryID) as LinkedInquiryID , s.SiteVisitKey
                        FROM ODS.EN_WarpOEM_ServiceVisitID ods
                        join EnergyDM.Dim_EnergyServiceSiteVisit S ON (ods.ServiceVisitID = S.ServiceVisitID and S.SourceType = 'Warp')
                        ) SV
                        Where (t.ServiceActivityID = SV.LinkedInquiryId and t.SourceType = 'Warp');
refrtableupdatequery :
refrtabledeletequery:
incrementallabel: Select isnull(max(tsdate),'1970-01-01') FROM ODS.EN_WarpOEM_Activity where SourceSystemKey = 51
                  |Select isnull(max(ts),0) FROM ODS.EN_WarpOEM_ServiceVisitID;
updateincrquery: UPDATE Audit.ETL_Incremental trg
                SET LastETLRunDate = IFNULL('{0}',trg.LastETLRunDate)
                ,ModifiedBy = 'EnergyDM.Fact_EnergyServiceActivity'
                ,ModifiedTime =  CURRENT_TIMESTAMP(0) AT TIME ZONE 'America/Los_Angeles'
                WHERE IsActive = 1
                AND TableSchemaName = 'ODS'
                AND TableName = 'EN_WarpOEM_Activity';

                UPDATE Audit.ETL_Incremental trg
                SET MaxKafkaBatchNumber = IFNULL({1},trg.MaxKafkaBatchNumber)
                ,ModifiedBy = 'EnergyDM.Fact_EnergyServiceActivity'
                ,ModifiedTime =  CURRENT_TIMESTAMP(0) AT TIME ZONE 'America/Los_Angeles'
                WHERE IsActive = 1
                AND TableSchemaName = 'ODS'
                AND TableName = 'EN_WarpOEM_ServiceVisitID';
executionsequence: updatequery,insertquery,refrtableinsertquery,updateincrquery
batchflag: false
incrementbatch : 100000